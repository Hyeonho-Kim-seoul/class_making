import streamlit as st
import pandas as pd
import numpy as np
import random
from typing import Dict, List
from datetime import datetime
import io

# ========================================
# ë°˜ë°°ì¹˜ í”„ë¡œê·¸ë¨ í•µì‹¬ ì•Œê³ ë¦¬ì¦˜
# ========================================
class ë°˜ë°°ì¹˜í”„ë¡œê·¸ë¨:
    def __init__(self, ë¡œê·¸_ì½œë°±=None):
        self.ë°˜ê°œìˆ˜ = None
        self.í•™ìƒë°ì´í„° = None
        self.ë‚¨ì_ì •ë ¬ = None
        self.ì—¬ì_ì •ë ¬ = None
        self.ë°°ì¹˜ê²°ê³¼ = None
        self.ë¡œê·¸ = ë¡œê·¸_ì½œë°± or (lambda x: None)
        
    def ì „ì²´_ìë™ì‹¤í–‰(self, ë°˜ê°œìˆ˜, ì—‘ì…€ë°ì´í„°, ëª©í‘œí‰ê· ì°¨ì´=0.3):
        self.ë°˜ê°œìˆ˜ = ë°˜ê°œìˆ˜
        
        self.ë¡œê·¸("=" * 50)
        self.ë¡œê·¸("ë°˜ë°°ì¹˜ ìë™í™” í”„ë¡œê·¸ë¨ ì‹œì‘")
        self.ë¡œê·¸("=" * 50)
        
        # 1ë‹¨ê³„
        self.ë¡œê·¸("\n[1ë‹¨ê³„] ì—‘ì…€ íŒŒì¼ ë¶„ì„...")
        self._íŒŒì¼ë¶„ì„(ì—‘ì…€ë°ì´í„°)
        self.ë¡œê·¸("âœ… 1ë‹¨ê³„ ì™„ë£Œ")
        
        # 2ë‹¨ê³„
        self.ë¡œê·¸("\n[2ë‹¨ê³„] ì„±ë³„ ë¶„ë¥˜ ë° ì„±ì  ì •ë ¬...")
        self._ì„±ë³„ë¶„ë¥˜()
        self.ë¡œê·¸("âœ… 2ë‹¨ê³„ ì™„ë£Œ")
        
        # 3ë‹¨ê³„
        self.ë¡œê·¸("\n[3ë‹¨ê³„] ì œì•½ì¡°ê±´ì„ ê³ ë ¤í•œ ë°˜ ë°°ì¹˜...")
        self._ë°˜ë°°ì¹˜()
        self.ë¡œê·¸("âœ… 3ë‹¨ê³„ ì™„ë£Œ")
        
        # 4ë‹¨ê³„
        self.ë¡œê·¸("\n[4ë‹¨ê³„] ì„±ì  ë¶„í¬ ë¶„ì„...")
        self._ì„±ì ë¶„í¬ë¶„ì„()
        self.ë¡œê·¸("âœ… 4ë‹¨ê³„ ì™„ë£Œ")
        
        # 5ë‹¨ê³„
        self.ë¡œê·¸("\n[5ë‹¨ê³„] í‰ê·  ì„±ì  ì¡°ì •...")
        self._í‰ê· ì¡°ì •(ëª©í‘œì°¨ì´=ëª©í‘œí‰ê· ì°¨ì´, ìµœëŒ€ë°˜ë³µ=10000)
        self.ë¡œê·¸("âœ… 5ë‹¨ê³„ ì™„ë£Œ")
        
        # ê²°ê³¼ ìš”ì•½
        self._ê²°ê³¼ìš”ì•½()
        
        return self.ë°°ì¹˜ê²°ê³¼
    
    def _íŒŒì¼ë¶„ì„(self, df):
        ì»¬ëŸ¼ë§¤í•‘ = {}
        if 'ì„±ëª…' in df.columns:
            ì»¬ëŸ¼ë§¤í•‘['ì„±ëª…'] = 'ì´ë¦„'
        if 'í‰ê· ' in df.columns:
            ì»¬ëŸ¼ë§¤í•‘['í‰ê· '] = 'ì„±ì '
        elif 'ì´ì ' in df.columns:
            ì»¬ëŸ¼ë§¤í•‘['ì´ì '] = 'ì„±ì '
        
        self.í•™ìƒë°ì´í„° = df.rename(columns=ì»¬ëŸ¼ë§¤í•‘)
        
        # ë¹„ê³  ì»¬ëŸ¼ì—ì„œ ì œì•½ì¡°ê±´ ì¶”ì¶œ
        if 'ë¹„ê³ ' in self.í•™ìƒë°ì´í„°.columns:
            self.í•™ìƒë°ì´í„°['ë™ëª…ì´ì¸'] = self.í•™ìƒë°ì´í„°['ë¹„ê³ '].apply(
                lambda x: 'ë™ëª…ì´ì¸' if pd.notna(x) and 'ë™ëª…ì´ì¸' in str(x) else np.nan
            )
            self.í•™ìƒë°ì´í„°['ìŒë‘¥ì´'] = self.í•™ìƒë°ì´í„°['ë¹„ê³ '].apply(
                lambda x: 'ìŒë‘¥ì´' if pd.notna(x) and 'ìŒë‘¥ì´' in str(x) else np.nan
            )
            self.í•™ìƒë°ì´í„°['ìš´ë™ë¶€'] = self.í•™ìƒë°ì´í„°['ë¹„ê³ '].apply(
                lambda x: 'ìš´ë™ë¶€' if pd.notna(x) and 'ìš´ë™ë¶€' in str(x) else np.nan
            )
            if self.í•™ìƒë°ì´í„°['ë™ëª…ì´ì¸'].notna().any():
                for ì´ë¦„ in self.í•™ìƒë°ì´í„°[self.í•™ìƒë°ì´í„°['ë™ëª…ì´ì¸'].notna()]['ì´ë¦„'].unique():
                    ê°™ì€ì´ë¦„ = self.í•™ìƒë°ì´í„°['ì´ë¦„'] == ì´ë¦„
                    if ê°™ì€ì´ë¦„.sum() > 1:
                        self.í•™ìƒë°ì´í„°.loc[ê°™ì€ì´ë¦„, 'ë™ëª…ì´ì¸'] = ì´ë¦„
        
        í•„ìˆ˜ì»¬ëŸ¼ = ['ì´ë¦„', 'ì„±ë³„', 'ì„±ì ']
        ëˆ„ë½ì»¬ëŸ¼ = [c for c in í•„ìˆ˜ì»¬ëŸ¼ if c not in self.í•™ìƒë°ì´í„°.columns]
        if ëˆ„ë½ì»¬ëŸ¼:
            raise ValueError(f"í•„ìˆ˜ ì»¬ëŸ¼ì´ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤: {ëˆ„ë½ì»¬ëŸ¼}\níŒŒì¼ì— ìˆëŠ” ì»¬ëŸ¼: {list(self.í•™ìƒë°ì´í„°.columns)}")
        
        ì „ì²´ë‚¨ì = len(self.í•™ìƒë°ì´í„°[self.í•™ìƒë°ì´í„°['ì„±ë³„'] == 'ë‚¨'])
        ì „ì²´ì—¬ì = len(self.í•™ìƒë°ì´í„°[self.í•™ìƒë°ì´í„°['ì„±ë³„'] == 'ì—¬'])
        
        self.ë¡œê·¸(f"  âœ“ ì´ {len(self.í•™ìƒë°ì´í„°)}ëª… (ë‚¨ {ì „ì²´ë‚¨ì}ëª…, ì—¬ {ì „ì²´ì—¬ì}ëª…)")
        self.ë¡œê·¸(f"  âœ“ {self.ë°˜ê°œìˆ˜}ê°œ ë°˜ìœ¼ë¡œ ë°°ì¹˜")
    
    def _ì„±ë³„ë¶„ë¥˜(self):
        ë‚¨ì = self.í•™ìƒë°ì´í„°[self.í•™ìƒë°ì´í„°['ì„±ë³„'] == 'ë‚¨'].copy()
        ì—¬ì = self.í•™ìƒë°ì´í„°[self.í•™ìƒë°ì´í„°['ì„±ë³„'] == 'ì—¬'].copy()
        self.ë‚¨ì_ì •ë ¬ = ë‚¨ì.sort_values('ì„±ì ', ascending=False)
        self.ì—¬ì_ì •ë ¬ = ì—¬ì.sort_values('ì„±ì ', ascending=False)
        self.ë¡œê·¸(f"  âœ“ ë‚¨ì {len(self.ë‚¨ì_ì •ë ¬)}ëª…, ì—¬ì {len(self.ì—¬ì_ì •ë ¬)}ëª… ì •ë ¬ ì™„ë£Œ")
    
    def _ì œì•½ì¡°ê±´_ë¶„ì„(self) -> Dict[str, List[str]]:
        ì œì•½ê·¸ë£¹ = {}
        for ì»¬ëŸ¼ in ['ë™ëª…ì´ì¸', 'ìŒë‘¥ì´', 'ìš´ë™ë¶€']:
            if ì»¬ëŸ¼ in self.í•™ìƒë°ì´í„°.columns:
                ê·¸ë£¹ë“¤ = self.í•™ìƒë°ì´í„°[self.í•™ìƒë°ì´í„°[ì»¬ëŸ¼].notna()].groupby(ì»¬ëŸ¼)['ì´ë¦„'].apply(list)
                for _, í•™ìƒë“¤ in ê·¸ë£¹ë“¤.items():
                    if len(í•™ìƒë“¤) > 1:
                        for í•™ìƒ in í•™ìƒë“¤:
                            if í•™ìƒ not in ì œì•½ê·¸ë£¹:
                                ì œì•½ê·¸ë£¹[í•™ìƒ] = []
                            ì œì•½ê·¸ë£¹[í•™ìƒ].extend([s for s in í•™ìƒë“¤ if s != í•™ìƒ])
        
        if 'ë¶„ë¦¬ê·¸ë£¹' in self.í•™ìƒë°ì´í„°.columns:
            ë¶„ë¦¬ê·¸ë£¹ = self.í•™ìƒë°ì´í„°[self.í•™ìƒë°ì´í„°['ë¶„ë¦¬ê·¸ë£¹'].notna()]['ë¶„ë¦¬ê·¸ë£¹'].unique()
            for ê·¸ë£¹ in ë¶„ë¦¬ê·¸ë£¹:
                í•™ìƒë“¤ = [s.strip() for s in str(ê·¸ë£¹).split('-')]
                if len(í•™ìƒë“¤) > 1:
                    for í•™ìƒ in í•™ìƒë“¤:
                        if í•™ìƒ not in ì œì•½ê·¸ë£¹:
                            ì œì•½ê·¸ë£¹[í•™ìƒ] = []
                        ì œì•½ê·¸ë£¹[í•™ìƒ].extend([s for s in í•™ìƒë“¤ if s != í•™ìƒ])
        
        for í•™ìƒ in ì œì•½ê·¸ë£¹:
            ì œì•½ê·¸ë£¹[í•™ìƒ] = list(set(ì œì•½ê·¸ë£¹[í•™ìƒ]))
        return ì œì•½ê·¸ë£¹
    
    def _ë±€ë“œë˜í”„íŠ¸_ë°°ì¹˜(self, ì •ë ¬ë°ì´í„°, ì œì•½ê·¸ë£¹, ë°˜ë³„ìµœëŒ€ì¸ì›, ì‹œì‘ì˜¤í”„ì…‹=0):
        ë°°ì¹˜ = {i: [] for i in range(1, self.ë°˜ê°œìˆ˜ + 1)}
        ë°˜ìˆœì„œ_ì›ë³¸ = list(range(1, self.ë°˜ê°œìˆ˜ + 1))
        ë°˜ìˆœì„œ = ë°˜ìˆœì„œ_ì›ë³¸[ì‹œì‘ì˜¤í”„ì…‹:] + ë°˜ìˆœì„œ_ì›ë³¸[:ì‹œì‘ì˜¤í”„ì…‹]
        
        for idx, (_, í•™ìƒ) in enumerate(ì •ë ¬ë°ì´í„°.iterrows()):
            ë¼ìš´ë“œ = idx // self.ë°˜ê°œìˆ˜
            í˜„ì¬ìˆœì„œ = ë°˜ìˆœì„œ[::-1] if ë¼ìš´ë“œ % 2 == 1 else ë°˜ìˆœì„œ
            
            ë°°ì¹˜ì™„ë£Œ = False
            ê¸°ë³¸ë°˜ë²ˆí˜¸ = í˜„ì¬ìˆœì„œ[idx % self.ë°˜ê°œìˆ˜]
            ì‹œë„ìˆœì„œ = [ê¸°ë³¸ë°˜ë²ˆí˜¸] + [r for r in í˜„ì¬ìˆœì„œ if r != ê¸°ë³¸ë°˜ë²ˆí˜¸]
            
            for ë°˜ë²ˆí˜¸ in ì‹œë„ìˆœì„œ:
                if len(ë°°ì¹˜[ë°˜ë²ˆí˜¸]) >= ë°˜ë³„ìµœëŒ€ì¸ì›[ë°˜ë²ˆí˜¸]:
                    continue
                í•™ìƒì´ë¦„ = í•™ìƒ['ì´ë¦„']
                if í•™ìƒì´ë¦„ in ì œì•½ê·¸ë£¹:
                    ë°°ì¹˜ëœí•™ìƒë“¤ = [self.í•™ìƒë°ì´í„°.loc[i, 'ì´ë¦„'] for i in ë°°ì¹˜[ë°˜ë²ˆí˜¸]]
                    if any(ì œì•½ in ë°°ì¹˜ëœí•™ìƒë“¤ for ì œì•½ in ì œì•½ê·¸ë£¹[í•™ìƒì´ë¦„]):
                        continue
                ë°°ì¹˜[ë°˜ë²ˆí˜¸].append(í•™ìƒ.name)
                ë°°ì¹˜ì™„ë£Œ = True
                break
            
            if not ë°°ì¹˜ì™„ë£Œ:
                ì—¬ìœ ë°˜ë“¤ = sorted(ë°˜ìˆœì„œ_ì›ë³¸, key=lambda x: ë°˜ë³„ìµœëŒ€ì¸ì›[x] - len(ë°°ì¹˜[x]), reverse=True)
                for ë°˜ë²ˆí˜¸ in ì—¬ìœ ë°˜ë“¤:
                    if len(ë°°ì¹˜[ë°˜ë²ˆí˜¸]) < ë°˜ë³„ìµœëŒ€ì¸ì›[ë°˜ë²ˆí˜¸]:
                        ë°°ì¹˜[ë°˜ë²ˆí˜¸].append(í•™ìƒ.name)
                        break
        return ë°°ì¹˜
    
    def _ì¸ì›ê· ë“±_ê³„ì‚°(self):
        ì „ì²´ë‚¨ì = len(self.ë‚¨ì_ì •ë ¬)
        ì „ì²´ì—¬ì = len(self.ì—¬ì_ì •ë ¬)
        ê¸°ë³¸ë‚¨ì = ì „ì²´ë‚¨ì // self.ë°˜ê°œìˆ˜
        ë‚¨ìì—¬ë¶„ = ì „ì²´ë‚¨ì % self.ë°˜ê°œìˆ˜
        ê¸°ë³¸ì—¬ì = ì „ì²´ì—¬ì // self.ë°˜ê°œìˆ˜
        ì—¬ìì—¬ë¶„ = ì „ì²´ì—¬ì % self.ë°˜ê°œìˆ˜
        
        ë‚¨ìë°˜ë³„ì¸ì› = {}
        ì—¬ìë°˜ë³„ì¸ì› = {}
        for i in range(1, self.ë°˜ê°œìˆ˜ + 1):
            ë‚¨ìë°˜ë³„ì¸ì›[i] = ê¸°ë³¸ë‚¨ì + (1 if i <= ë‚¨ìì—¬ë¶„ else 0)
            ì—¬ìë°˜ë³„ì¸ì›[i] = ê¸°ë³¸ì—¬ì + (1 if i > (self.ë°˜ê°œìˆ˜ - ì—¬ìì—¬ë¶„) else 0)
        
        ë°˜ë³„ì´ì¸ì› = {i: ë‚¨ìë°˜ë³„ì¸ì›[i] + ì—¬ìë°˜ë³„ì¸ì›[i] for i in range(1, self.ë°˜ê°œìˆ˜ + 1)}
        ìµœëŒ€ = max(ë°˜ë³„ì´ì¸ì›.values())
        ìµœì†Œ = min(ë°˜ë³„ì´ì¸ì›.values())
        self.ë¡œê·¸(f"  âœ“ ì¸ì› ê· ë“±í™”: ë°˜ë³„ {ìµœì†Œ}~{ìµœëŒ€}ëª… (ì°¨ì´ {ìµœëŒ€-ìµœì†Œ}ëª…)")
        
        return ë‚¨ìë°˜ë³„ì¸ì›, ì—¬ìë°˜ë³„ì¸ì›
    
    def _ë°˜ë°°ì¹˜(self):
        random.seed(42)
        ì œì•½ê·¸ë£¹ = self._ì œì•½ì¡°ê±´_ë¶„ì„()
        self.ë¡œê·¸(f"  âœ“ ì œì•½ì¡°ê±´ ë¶„ì„ ì™„ë£Œ ({len(ì œì•½ê·¸ë£¹)}ëª…)")
        
        ë‚¨ìë°˜ë³„ì¸ì›, ì—¬ìë°˜ë³„ì¸ì› = self._ì¸ì›ê· ë“±_ê³„ì‚°()
        ë‚¨ìë°°ì¹˜ = self._ë±€ë“œë˜í”„íŠ¸_ë°°ì¹˜(self.ë‚¨ì_ì •ë ¬, ì œì•½ê·¸ë£¹, ë‚¨ìë°˜ë³„ì¸ì›, ì‹œì‘ì˜¤í”„ì…‹=0)
        ì—¬ì_ì˜¤í”„ì…‹ = self.ë°˜ê°œìˆ˜ // 2
        ì—¬ìë°°ì¹˜ = self._ë±€ë“œë˜í”„íŠ¸_ë°°ì¹˜(self.ì—¬ì_ì •ë ¬, ì œì•½ê·¸ë£¹, ì—¬ìë°˜ë³„ì¸ì›, ì‹œì‘ì˜¤í”„ì…‹=ì—¬ì_ì˜¤í”„ì…‹)
        self.ë¡œê·¸(f"  âœ“ ë‚¨ë…€ ìˆœìœ„ ë¶„ì‚° ì ìš© (ì—¬ì ì˜¤í”„ì…‹: {ì—¬ì_ì˜¤í”„ì…‹})")
        
        # ìµœê³ ì ì í™•ì¸ ë° ì¡°ì •
        ë‚¨ììµœê³ ë°˜ = ì—¬ììµœê³ ë°˜ = None
        for ë°˜ë²ˆí˜¸, í•™ìƒë“¤ in ë‚¨ìë°°ì¹˜.items():
            if self.ë‚¨ì_ì •ë ¬.index[0] in í•™ìƒë“¤:
                ë‚¨ììµœê³ ë°˜ = ë°˜ë²ˆí˜¸
                break
        for ë°˜ë²ˆí˜¸, í•™ìƒë“¤ in ì—¬ìë°°ì¹˜.items():
            if self.ì—¬ì_ì •ë ¬.index[0] in í•™ìƒë“¤:
                ì—¬ììµœê³ ë°˜ = ë°˜ë²ˆí˜¸
                break
        
        if ë‚¨ììµœê³ ë°˜ == ì—¬ììµœê³ ë°˜:
            ë‹¤ë¥¸ë°˜ = [i for i in range(1, self.ë°˜ê°œìˆ˜ + 1) if i != ë‚¨ììµœê³ ë°˜][0]
            ì—¬ììµœê³ _idx = self.ì—¬ì_ì •ë ¬.index[0]
            êµí™˜ëŒ€ìƒ_idx = ì—¬ìë°°ì¹˜[ë‹¤ë¥¸ë°˜][0]
            ì—¬ìë°°ì¹˜[ì—¬ììµœê³ ë°˜].remove(ì—¬ììµœê³ _idx)
            ì—¬ìë°°ì¹˜[ë‹¤ë¥¸ë°˜].remove(êµí™˜ëŒ€ìƒ_idx)
            ì—¬ìë°°ì¹˜[ì—¬ììµœê³ ë°˜].append(êµí™˜ëŒ€ìƒ_idx)
            ì—¬ìë°°ì¹˜[ë‹¤ë¥¸ë°˜].append(ì—¬ììµœê³ _idx)
        
        ë°°ì¹˜ëª©ë¡ = []
        for ë°˜ë²ˆí˜¸ in range(1, self.ë°˜ê°œìˆ˜ + 1):
            for í•™ìƒ_idx in ë‚¨ìë°°ì¹˜[ë°˜ë²ˆí˜¸] + ì—¬ìë°°ì¹˜[ë°˜ë²ˆí˜¸]:
                í•™ìƒì •ë³´ = self.í•™ìƒë°ì´í„°.loc[í•™ìƒ_idx].copy()
                í•™ìƒì •ë³´['ë°°ì •ë°˜'] = ë°˜ë²ˆí˜¸
                ë°°ì¹˜ëª©ë¡.append(í•™ìƒì •ë³´)
        
        self.ë°°ì¹˜ê²°ê³¼ = pd.DataFrame(ë°°ì¹˜ëª©ë¡)
        ë°˜ë³„ì¸ì› = [len(self.ë°°ì¹˜ê²°ê³¼[self.ë°°ì¹˜ê²°ê³¼['ë°°ì •ë°˜'] == i]) for i in range(1, self.ë°˜ê°œìˆ˜ + 1)]
        self.ë¡œê·¸(f"  âœ“ ë°°ì¹˜ ì™„ë£Œ: {len(self.ë°°ì¹˜ê²°ê³¼)}ëª… (ë°˜ë³„ ì¸ì› ì°¨ì´: {max(ë°˜ë³„ì¸ì›)-min(ë°˜ë³„ì¸ì›)}ëª…)")
    
    def _ì„±ì ë¶„í¬ë¶„ì„(self):
        ë°˜ë³„í‰ê·  = []
        for ë°˜ë²ˆí˜¸ in range(1, self.ë°˜ê°œìˆ˜ + 1):
            ë°˜ë°ì´í„° = self.ë°°ì¹˜ê²°ê³¼[self.ë°°ì¹˜ê²°ê³¼['ë°°ì •ë°˜'] == ë°˜ë²ˆí˜¸]
            ë°˜ë³„í‰ê· .append(ë°˜ë°ì´í„°['ì„±ì '].mean())
        ì°¨ì´ = max(ë°˜ë³„í‰ê· ) - min(ë°˜ë³„í‰ê· )
        self.ë¡œê·¸(f"  âœ“ ë°˜ë³„ í‰ê·  ì°¨ì´: {ì°¨ì´:.2f}ì ")
    
    def _ì œì•½ì¡°ê±´_í™•ì¸(self, í•™ìƒì´ë¦„, ëŒ€ìƒë°˜ë²ˆí˜¸, ì œì•½ê·¸ë£¹, ì œì™¸í•™ìƒì´ë¦„=None):
        if í•™ìƒì´ë¦„ not in ì œì•½ê·¸ë£¹:
            return False
        ëŒ€ìƒë°˜_í•™ìƒë“¤ = self.ë°°ì¹˜ê²°ê³¼[
            (self.ë°°ì¹˜ê²°ê³¼['ë°°ì •ë°˜'] == ëŒ€ìƒë°˜ë²ˆí˜¸) &
            (self.ë°°ì¹˜ê²°ê³¼['ì´ë¦„'] != ì œì™¸í•™ìƒì´ë¦„)
        ]['ì´ë¦„'].tolist()
        return any(ì œì•½ in ëŒ€ìƒë°˜_í•™ìƒë“¤ for ì œì•½ in ì œì•½ê·¸ë£¹[í•™ìƒì´ë¦„])
    
    def _í‰ê· ì¡°ì •(self, ëª©í‘œì°¨ì´=0.3, ìµœëŒ€ë°˜ë³µ=10000):
        def í‰ê· ê³„ì‚°():
            return {ë°˜: self.ë°°ì¹˜ê²°ê³¼[self.ë°°ì¹˜ê²°ê³¼['ë°°ì •ë°˜'] == ë°˜]['ì„±ì '].mean() 
                    for ë°˜ in range(1, self.ë°˜ê°œìˆ˜ + 1)}
        def ìµœëŒ€ì°¨ì´ê³„ì‚°(í‰ê· ):
            return max(í‰ê· .values()) - min(í‰ê· .values())
        
        ë°˜ë³„í‰ê·  = í‰ê· ê³„ì‚°()
        ì´ˆê¸°ì°¨ì´ = ìµœëŒ€ì°¨ì´ê³„ì‚°(ë°˜ë³„í‰ê· )
        
        if ì´ˆê¸°ì°¨ì´ <= ëª©í‘œì°¨ì´:
            self.ë¡œê·¸(f"  âœ“ ì´ë¯¸ ëª©í‘œ ë‹¬ì„± (ì°¨ì´: {ì´ˆê¸°ì°¨ì´:.2f}ì )")
            return
        
        self.ë¡œê·¸(f"  âœ“ ì´ˆê¸° ì°¨ì´: {ì´ˆê¸°ì°¨ì´:.2f}ì  â†’ ëª©í‘œ: {ëª©í‘œì°¨ì´:.2f}ì ")
        
        ì œì•½ê·¸ë£¹ = self._ì œì•½ì¡°ê±´_ë¶„ì„()
        ì¡°ì •íšŸìˆ˜ = 0
        ì—°ì†ì‹¤íŒ¨ = 0
        
        for ë°˜ë³µ in range(ìµœëŒ€ë°˜ë³µ):
            ë°˜ë³„í‰ê·  = í‰ê· ê³„ì‚°()
            í˜„ì¬ì°¨ì´ = ìµœëŒ€ì°¨ì´ê³„ì‚°(ë°˜ë³„í‰ê· )
            
            if í˜„ì¬ì°¨ì´ <= ëª©í‘œì°¨ì´:
                self.ë¡œê·¸(f"  ğŸ¯ ëª©í‘œ ë‹¬ì„±! ({ì¡°ì •íšŸìˆ˜}íšŒ ì¡°ì •, ì°¨ì´: {í˜„ì¬ì°¨ì´:.2f}ì )")
                break
            
            ìµœì„ ì˜_êµí™˜ = None
            ìµœì„ ì˜_ì°¨ì´ = í˜„ì¬ì°¨ì´
            
            for ë°˜A in range(1, self.ë°˜ê°œìˆ˜ + 1):
                for ë°˜B in range(ë°˜A + 1, self.ë°˜ê°œìˆ˜ + 1):
                    ë°˜Aë°ì´í„° = self.ë°°ì¹˜ê²°ê³¼[self.ë°°ì¹˜ê²°ê³¼['ë°°ì •ë°˜'] == ë°˜A]
                    ë°˜Bë°ì´í„° = self.ë°°ì¹˜ê²°ê³¼[self.ë°°ì¹˜ê²°ê³¼['ë°°ì •ë°˜'] == ë°˜B]
                    
                    for ì„±ë³„ in ['ë‚¨', 'ì—¬']:
                        for _, í•™ìƒA in ë°˜Aë°ì´í„°[ë°˜Aë°ì´í„°['ì„±ë³„'] == ì„±ë³„].iterrows():
                            for _, í•™ìƒB in ë°˜Bë°ì´í„°[ë°˜Bë°ì´í„°['ì„±ë³„'] == ì„±ë³„].iterrows():
                                ìƒˆí‰ê·  = ë°˜ë³„í‰ê· .copy()
                                ìƒˆí‰ê· [ë°˜A] = (ë°˜ë³„í‰ê· [ë°˜A] * len(ë°˜Aë°ì´í„°) - í•™ìƒA['ì„±ì '] + í•™ìƒB['ì„±ì ']) / len(ë°˜Aë°ì´í„°)
                                ìƒˆí‰ê· [ë°˜B] = (ë°˜ë³„í‰ê· [ë°˜B] * len(ë°˜Bë°ì´í„°) - í•™ìƒB['ì„±ì '] + í•™ìƒA['ì„±ì ']) / len(ë°˜Bë°ì´í„°)
                                ì˜ˆìƒì°¨ì´ = ìµœëŒ€ì°¨ì´ê³„ì‚°(ìƒˆí‰ê· )
                                
                                if ì˜ˆìƒì°¨ì´ < ìµœì„ ì˜_ì°¨ì´:
                                    if not self._ì œì•½ì¡°ê±´_í™•ì¸(í•™ìƒA['ì´ë¦„'], ë°˜B, ì œì•½ê·¸ë£¹, í•™ìƒB['ì´ë¦„']) and \
                                       not self._ì œì•½ì¡°ê±´_í™•ì¸(í•™ìƒB['ì´ë¦„'], ë°˜A, ì œì•½ê·¸ë£¹, í•™ìƒA['ì´ë¦„']):
                                        ìµœì„ ì˜_ì°¨ì´ = ì˜ˆìƒì°¨ì´
                                        ìµœì„ ì˜_êµí™˜ = ('1:1', ë°˜A, ë°˜B, í•™ìƒA, í•™ìƒB)
            
            # 3ì êµí™˜
            if ìµœì„ ì˜_ì°¨ì´ > ëª©í‘œì°¨ì´ and ì—°ì†ì‹¤íŒ¨ >= 2:
                ë°˜ëª©ë¡ = list(range(1, self.ë°˜ê°œìˆ˜ + 1))
                for ë°˜A in ë°˜ëª©ë¡:
                    for ë°˜B in ë°˜ëª©ë¡:
                        if ë°˜B == ë°˜A: continue
                        for ë°˜C in ë°˜ëª©ë¡:
                            if ë°˜C in (ë°˜A, ë°˜B): continue
                            ë°˜Aë°ì´í„° = self.ë°°ì¹˜ê²°ê³¼[self.ë°°ì¹˜ê²°ê³¼['ë°°ì •ë°˜'] == ë°˜A]
                            ë°˜Bë°ì´í„° = self.ë°°ì¹˜ê²°ê³¼[self.ë°°ì¹˜ê²°ê³¼['ë°°ì •ë°˜'] == ë°˜B]
                            ë°˜Cë°ì´í„° = self.ë°°ì¹˜ê²°ê³¼[self.ë°°ì¹˜ê²°ê³¼['ë°°ì •ë°˜'] == ë°˜C]
                            for ì„±ë³„ in ['ë‚¨', 'ì—¬']:
                                sA = ë°˜Aë°ì´í„°[ë°˜Aë°ì´í„°['ì„±ë³„'] == ì„±ë³„].sample(frac=1, random_state=ë°˜ë³µ).head(3)
                                sB = ë°˜Bë°ì´í„°[ë°˜Bë°ì´í„°['ì„±ë³„'] == ì„±ë³„].sample(frac=1, random_state=ë°˜ë³µ+1).head(3)
                                sC = ë°˜Cë°ì´í„°[ë°˜Cë°ì´í„°['ì„±ë³„'] == ì„±ë³„].sample(frac=1, random_state=ë°˜ë³µ+2).head(3)
                                for _, a in sA.iterrows():
                                    for _, b in sB.iterrows():
                                        for _, c in sC.iterrows():
                                            ìƒˆí‰ê·  = ë°˜ë³„í‰ê· .copy()
                                            ìƒˆí‰ê· [ë°˜A] = (ë°˜ë³„í‰ê· [ë°˜A]*len(ë°˜Aë°ì´í„°) - a['ì„±ì '] + c['ì„±ì '])/len(ë°˜Aë°ì´í„°)
                                            ìƒˆí‰ê· [ë°˜B] = (ë°˜ë³„í‰ê· [ë°˜B]*len(ë°˜Bë°ì´í„°) - b['ì„±ì '] + a['ì„±ì '])/len(ë°˜Bë°ì´í„°)
                                            ìƒˆí‰ê· [ë°˜C] = (ë°˜ë³„í‰ê· [ë°˜C]*len(ë°˜Cë°ì´í„°) - c['ì„±ì '] + b['ì„±ì '])/len(ë°˜Cë°ì´í„°)
                                            ì˜ˆìƒì°¨ì´ = ìµœëŒ€ì°¨ì´ê³„ì‚°(ìƒˆí‰ê· )
                                            if ì˜ˆìƒì°¨ì´ < ìµœì„ ì˜_ì°¨ì´:
                                                if not any([
                                                    self._ì œì•½ì¡°ê±´_í™•ì¸(a['ì´ë¦„'], ë°˜B, ì œì•½ê·¸ë£¹, b['ì´ë¦„']),
                                                    self._ì œì•½ì¡°ê±´_í™•ì¸(b['ì´ë¦„'], ë°˜C, ì œì•½ê·¸ë£¹, c['ì´ë¦„']),
                                                    self._ì œì•½ì¡°ê±´_í™•ì¸(c['ì´ë¦„'], ë°˜A, ì œì•½ê·¸ë£¹, a['ì´ë¦„'])
                                                ]):
                                                    ìµœì„ ì˜_ì°¨ì´ = ì˜ˆìƒì°¨ì´
                                                    ìµœì„ ì˜_êµí™˜ = ('3way', ë°˜A, ë°˜B, ë°˜C, a, b, c)
            
            if ìµœì„ ì˜_êµí™˜ and ìµœì„ ì˜_ì°¨ì´ < í˜„ì¬ì°¨ì´:
                if ìµœì„ ì˜_êµí™˜[0] == '1:1':
                    _, ë°˜A, ë°˜B, í•™ìƒA, í•™ìƒB = ìµœì„ ì˜_êµí™˜
                    self.ë°°ì¹˜ê²°ê³¼.loc[í•™ìƒA.name, 'ë°°ì •ë°˜'] = ë°˜B
                    self.ë°°ì¹˜ê²°ê³¼.loc[í•™ìƒB.name, 'ë°°ì •ë°˜'] = ë°˜A
                else:
                    _, ë°˜A, ë°˜B, ë°˜C, a, b, c = ìµœì„ ì˜_êµí™˜
                    self.ë°°ì¹˜ê²°ê³¼.loc[a.name, 'ë°°ì •ë°˜'] = ë°˜B
                    self.ë°°ì¹˜ê²°ê³¼.loc[b.name, 'ë°°ì •ë°˜'] = ë°˜C
                    self.ë°°ì¹˜ê²°ê³¼.loc[c.name, 'ë°°ì •ë°˜'] = ë°˜A
                ì¡°ì •íšŸìˆ˜ += 1
                ì—°ì†ì‹¤íŒ¨ = 0
                if ì¡°ì •íšŸìˆ˜ % 10 == 0:
                    self.ë¡œê·¸(f"    ... {ì¡°ì •íšŸìˆ˜}íšŒ ì¡°ì • ì¤‘ (í˜„ì¬ ì°¨ì´: {ìµœëŒ€ì°¨ì´ê³„ì‚°(í‰ê· ê³„ì‚°()):.2f}ì )")
            else:
                ì—°ì†ì‹¤íŒ¨ += 1
                if ì—°ì†ì‹¤íŒ¨ >= 10:
                    break
        
        ìµœì¢… = í‰ê· ê³„ì‚°()
        ìµœì¢…ì°¨ì´ = ìµœëŒ€ì°¨ì´ê³„ì‚°(ìµœì¢…)
        self.ë¡œê·¸(f"  âœ“ {ì¡°ì •íšŸìˆ˜}íšŒ ì¡°ì • ì™„ë£Œ")
        self.ë¡œê·¸(f"  âœ“ í‰ê·  ì°¨ì´: {ì´ˆê¸°ì°¨ì´:.2f}ì  â†’ {ìµœì¢…ì°¨ì´:.2f}ì ")
    
    def _ê²°ê³¼ìš”ì•½(self):
        self.ë¡œê·¸("\n" + "=" * 50)
        self.ë¡œê·¸("ğŸ‰ ë°˜ë°°ì¹˜ ì™„ë£Œ!")
        self.ë¡œê·¸("=" * 50)
        
        for ë°˜ë²ˆí˜¸ in range(1, self.ë°˜ê°œìˆ˜ + 1):
            ë°˜ë°ì´í„° = self.ë°°ì¹˜ê²°ê³¼[self.ë°°ì¹˜ê²°ê³¼['ë°°ì •ë°˜'] == ë°˜ë²ˆí˜¸]
            ë‚¨ = len(ë°˜ë°ì´í„°[ë°˜ë°ì´í„°['ì„±ë³„'] == 'ë‚¨'])
            ì—¬ = len(ë°˜ë°ì´í„°[ë°˜ë°ì´í„°['ì„±ë³„'] == 'ì—¬'])
            í‰ê·  = ë°˜ë°ì´í„°['ì„±ì '].mean()
            self.ë¡œê·¸(f"  {ë°˜ë²ˆí˜¸}ë°˜: ë‚¨{ë‚¨}ëª…, ì—¬{ì—¬}ëª… (ì´ {len(ë°˜ë°ì´í„°)}ëª…) - í‰ê·  {í‰ê· :.2f}ì ")
        
        ë°˜ë³„í‰ê·  = [self.ë°°ì¹˜ê²°ê³¼[self.ë°°ì¹˜ê²°ê³¼['ë°°ì •ë°˜'] == i]['ì„±ì '].mean() for i in range(1, self.ë°˜ê°œìˆ˜ + 1)]
        ë°˜ë³„ì¸ì› = [len(self.ë°°ì¹˜ê²°ê³¼[self.ë°°ì¹˜ê²°ê³¼['ë°°ì •ë°˜'] == i]) for i in range(1, self.ë°˜ê°œìˆ˜ + 1)]
        self.ë¡œê·¸(f"\n  ğŸ“ˆ ë°˜ë³„ í‰ê·  ì°¨ì´: {max(ë°˜ë³„í‰ê· )-min(ë°˜ë³„í‰ê· ):.2f}ì ")
        self.ë¡œê·¸(f"  ğŸ‘¥ ë°˜ë³„ ì¸ì› ì°¨ì´: {max(ë°˜ë³„ì¸ì›)-min(ë°˜ë³„ì¸ì›)}ëª…")

    def ê²°ê³¼_ì—‘ì…€ìƒì„±(self):
        """ì—‘ì…€ ë‹¤ìš´ë¡œë“œìš© BytesIO ë°˜í™˜"""
        from openpyxl.styles import PatternFill, Font, Alignment, Border, Side
        
        df = self.ë°°ì¹˜ê²°ê³¼.copy()
        
        # ì„±ë³„ ìˆœìœ„ ì¶”ê°€
        ë‚¨ìë§ˆìŠ¤í¬ = df['ì„±ë³„'] == 'ë‚¨'
        ë‚¨ìì¸ë±ìŠ¤ = df[ë‚¨ìë§ˆìŠ¤í¬].sort_values('ì„±ì ', ascending=False).index
        ë‚¨ììˆœìœ„ = {idx: rank for rank, idx in enumerate(ë‚¨ìì¸ë±ìŠ¤, 1)}
        df.loc[ë‚¨ìë§ˆìŠ¤í¬, 'ë‚¨ìì¤‘ìˆœìœ„'] = df[ë‚¨ìë§ˆìŠ¤í¬].index.map(ë‚¨ììˆœìœ„)
        
        ì—¬ìë§ˆìŠ¤í¬ = df['ì„±ë³„'] == 'ì—¬'
        ì—¬ìì¸ë±ìŠ¤ = df[ì—¬ìë§ˆìŠ¤í¬].sort_values('ì„±ì ', ascending=False).index
        ì—¬ììˆœìœ„ = {idx: rank for rank, idx in enumerate(ì—¬ìì¸ë±ìŠ¤, 1)}
        df.loc[ì—¬ìë§ˆìŠ¤í¬, 'ì—¬ìì¤‘ìˆœìœ„'] = df[ì—¬ìë§ˆìŠ¤í¬].index.map(ì—¬ììˆœìœ„)
        
        df['ë‚¨ìì¤‘ìˆœìœ„'] = df.apply(lambda x: int(x['ë‚¨ìì¤‘ìˆœìœ„']) if x['ì„±ë³„'] == 'ë‚¨' and pd.notna(x.get('ë‚¨ìì¤‘ìˆœìœ„')) else '', axis=1)
        df['ì—¬ìì¤‘ìˆœìœ„'] = df.apply(lambda x: int(x['ì—¬ìì¤‘ìˆœìœ„']) if x['ì„±ë³„'] == 'ì—¬' and pd.notna(x.get('ì—¬ìì¤‘ìˆœìœ„')) else '', axis=1)
        
        df_ì •ë ¬ = df.sort_values(by=['ë°°ì •ë°˜', 'ì„±ë³„', 'ì„±ì '], ascending=[True, True, False]).reset_index(drop=True)
        
        output = io.BytesIO()
        
        with pd.ExcelWriter(output, engine='openpyxl') as writer:
            df_ì •ë ¬.to_excel(writer, sheet_name='ë°°ì¹˜ê²°ê³¼', index=False)
            
            í†µê³„ = []
            for ë°˜ë²ˆí˜¸ in range(1, self.ë°˜ê°œìˆ˜ + 1):
                ë°˜ë°ì´í„° = df_ì •ë ¬[df_ì •ë ¬['ë°°ì •ë°˜'] == ë°˜ë²ˆí˜¸]
                ë‚¨ì = ë°˜ë°ì´í„°[ë°˜ë°ì´í„°['ì„±ë³„'] == 'ë‚¨']
                ì—¬ì = ë°˜ë°ì´í„°[ë°˜ë°ì´í„°['ì„±ë³„'] == 'ì—¬']
                í†µê³„.append({
                    'ë°˜': f"{ë°˜ë²ˆí˜¸}ë°˜",
                    'ì „ì²´ì¸ì›': len(ë°˜ë°ì´í„°),
                    'ë‚¨ìì¸ì›': len(ë‚¨ì),
                    'ì—¬ìì¸ì›': len(ì—¬ì),
                    'ì „ì²´í‰ê· ': round(ë°˜ë°ì´í„°['ì„±ì '].mean(), 2),
                    'ë‚¨ìí‰ê· ': round(ë‚¨ì['ì„±ì '].mean(), 2) if len(ë‚¨ì) > 0 else 0,
                    'ì—¬ìí‰ê· ': round(ì—¬ì['ì„±ì '].mean(), 2) if len(ì—¬ì) > 0 else 0,
                    'ìµœê³ ì ': round(ë°˜ë°ì´í„°['ì„±ì '].max(), 2),
                    'ìµœì €ì ': round(ë°˜ë°ì´í„°['ì„±ì '].min(), 2),
                })
            pd.DataFrame(í†µê³„).to_excel(writer, sheet_name='ë°˜ë³„í†µê³„', index=False)
        
        # ì„œì‹ ì ìš©
        from openpyxl import load_workbook
        from openpyxl.styles import PatternFill, Font, Alignment, Border, Side
        
        output.seek(0)
        wb = load_workbook(output)
        
        ws = wb['ë°°ì¹˜ê²°ê³¼']
        header_fill = PatternFill(start_color="4472C4", end_color="4472C4", fill_type="solid")
        header_font = Font(bold=True, color="FFFFFF", size=11)
        center = Alignment(horizontal="center", vertical="center")
        border = Border(left=Side(style='thin'), right=Side(style='thin'), top=Side(style='thin'), bottom=Side(style='thin'))
        
        for cell in ws[1]:
            cell.fill = header_fill
            cell.font = header_font
            cell.alignment = center
        
        ë°˜_ìƒ‰ìƒ = {1: "E7E6F7", 2: "FCE4D6", 3: "D9F2E6", 4: "FFF2CC", 5: "F4CCCC", 6: "E2EFD9", 7: "FCE4EC", 8: "FFF9E6"}
        ë°°ì •ë°˜_col = df_ì •ë ¬.columns.get_loc('ë°°ì •ë°˜') + 1
        
        for row in range(2, ws.max_row + 1):
            ë°˜ = ws.cell(row, ë°°ì •ë°˜_col).value
            fill = PatternFill(start_color=ë°˜_ìƒ‰ìƒ.get(ë°˜, "FFFFFF"), end_color=ë°˜_ìƒ‰ìƒ.get(ë°˜, "FFFFFF"), fill_type="solid")
            for col in range(1, ws.max_column + 1):
                c = ws.cell(row, col)
                c.fill = fill
                c.alignment = center
                c.border = border
        
        for col in ws.columns:
            letter = col[0].column_letter
            max_len = max((len(str(c.value or '')) for c in col), default=8)
            ws.column_dimensions[letter].width = min(max_len + 2, 30)
        
        ws2 = wb['ë°˜ë³„í†µê³„']
        stat_fill = PatternFill(start_color="70AD47", end_color="70AD47", fill_type="solid")
        for cell in ws2[1]:
            cell.fill = stat_fill
            cell.font = header_font
            cell.alignment = center
        for row in range(2, ws2.max_row + 1):
            for col in range(1, ws2.max_column + 1):
                c = ws2.cell(row, col)
                c.alignment = center
                c.border = border
        for col in ws2.columns:
            letter = col[0].column_letter
            max_len = max((len(str(c.value or '')) for c in col), default=8)
            ws2.column_dimensions[letter].width = min(max_len + 2, 20)
        
        output2 = io.BytesIO()
        wb.save(output2)
        output2.seek(0)
        return output2


# ========================================
# Streamlit ì›¹ UI
# ========================================

st.set_page_config(
    page_title="ë°˜ë°°ì¹˜ ìë™í™” í”„ë¡œê·¸ë¨",
    page_icon="ğŸ«",
    layout="centered"
)

# CSS ìŠ¤íƒ€ì¼
st.markdown("""
<style>
    .main-title {
        text-align: center;
        color: #1a5276;
        font-size: 2.2rem;
        font-weight: bold;
        margin-bottom: 0.5rem;
    }
    .sub-title {
        text-align: center;
        color: #666;
        font-size: 1.1rem;
        margin-bottom: 2rem;
    }
    .result-box {
        background-color: #f0f8ff;
        border-radius: 10px;
        padding: 20px;
        margin: 10px 0;
        border: 1px solid #b8d4e3;
    }
    .stButton>button {
        width: 100%;
        height: 60px;
        font-size: 1.3rem;
        font-weight: bold;
    }
</style>
""", unsafe_allow_html=True)

st.markdown('<p class="main-title">ğŸ« ë°˜ë°°ì¹˜ ìë™í™” í”„ë¡œê·¸ë¨</p>', unsafe_allow_html=True)
st.markdown('<p class="sub-title">í•™ìƒ ëª…ë¶€ë¥¼ ì˜¬ë ¤ì£¼ì„¸ìš”. ìë™ìœ¼ë¡œ ë°˜ì„ ë°°ì¹˜í•´ ë“œë¦½ë‹ˆë‹¤!</p>', unsafe_allow_html=True)

st.divider()

# ===== 1. íŒŒì¼ ì—…ë¡œë“œ =====
st.markdown("### ğŸ“ 1ë‹¨ê³„: í•™ìƒ ëª…ë¶€ íŒŒì¼ ì˜¬ë¦¬ê¸°")
st.info("ğŸ’¡ ì—‘ì…€ íŒŒì¼(.xlsx)ì„ ì˜¬ë ¤ì£¼ì„¸ìš”. íŒŒì¼ì— **ì´ë¦„(ë˜ëŠ” ì„±ëª…)**, **ì„±ë³„**, **ì„±ì (ë˜ëŠ” í‰ê· /ì´ì )** ì»¬ëŸ¼ì´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.")

uploaded_file = st.file_uploader(
    "ì—‘ì…€ íŒŒì¼ì„ ì—¬ê¸°ì— ëŒì–´ë‹¤ ë†“ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì„ íƒí•˜ì„¸ìš”",
    type=['xlsx', 'xls'],
    help="í•™ìƒ ëª…ë¶€ ì—‘ì…€ íŒŒì¼ì„ ì˜¬ë ¤ì£¼ì„¸ìš”"
)

if uploaded_file:
    try:
        df_ì›ë³¸ = pd.read_excel(uploaded_file, engine='openpyxl')
        st.success(f"âœ… íŒŒì¼ ë¡œë“œ ì™„ë£Œ! (ì´ {len(df_ì›ë³¸)}ëª…)")
        
        with st.expander("ğŸ“‹ íŒŒì¼ ë¯¸ë¦¬ë³´ê¸° (í´ë¦­í•˜ì—¬ í¼ì¹˜ê¸°)"):
            st.dataframe(df_ì›ë³¸.head(10), use_container_width=True)
    except Exception as e:
        st.error(f"âŒ íŒŒì¼ì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: {str(e)}")
        st.stop()

    st.divider()

    # ===== 2. ì„¤ì • =====
    st.markdown("### âš™ï¸ 2ë‹¨ê³„: ì„¤ì •")
    
    col1, col2 = st.columns(2)
    with col1:
        ë°˜ê°œìˆ˜ = st.number_input(
            "ë°˜ ê°œìˆ˜", 
            min_value=2, max_value=20, value=6,
            help="í•™ìƒë“¤ì„ ëª‡ ê°œ ë°˜ìœ¼ë¡œ ë‚˜ëˆŒì§€ ì„¤ì •í•©ë‹ˆë‹¤"
        )
    with col2:
        ëª©í‘œì°¨ì´ = st.number_input(
            "ë°˜ë³„ í‰ê·  ì°¨ì´ ëª©í‘œ (ì )", 
            min_value=0.1, max_value=5.0, value=0.3, step=0.1,
            help="ë°˜ë³„ í‰ê·  ì„±ì ì˜ ìµœëŒ€ ì°¨ì´ë¥¼ ëª‡ ì  ì´ë‚´ë¡œ ë§ì¶œì§€ ì„¤ì •í•©ë‹ˆë‹¤"
        )

    st.divider()

    # ===== 3. ì‹¤í–‰ =====
    st.markdown("### ğŸš€ 3ë‹¨ê³„: ë°˜ë°°ì¹˜ ì‹¤í–‰")
    
    if st.button("ğŸ¯ ë°˜ë°°ì¹˜ ì‹œì‘!", type="primary", use_container_width=True):
        
        ë¡œê·¸_ì»¨í…Œì´ë„ˆ = st.empty()
        ë¡œê·¸_í…ìŠ¤íŠ¸ = []
        
        def ë¡œê·¸_ì¶”ê°€(msg):
            ë¡œê·¸_í…ìŠ¤íŠ¸.append(msg)
            ë¡œê·¸_ì»¨í…Œì´ë„ˆ.code('\n'.join(ë¡œê·¸_í…ìŠ¤íŠ¸), language=None)
        
        with st.spinner("ë°˜ë°°ì¹˜ ì§„í–‰ ì¤‘... (ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”)"):
            try:
                í”„ë¡œê·¸ë¨ = ë°˜ë°°ì¹˜í”„ë¡œê·¸ë¨(ë¡œê·¸_ì½œë°±=ë¡œê·¸_ì¶”ê°€)
                ê²°ê³¼ = í”„ë¡œê·¸ë¨.ì „ì²´_ìë™ì‹¤í–‰(
                    ë°˜ê°œìˆ˜=ë°˜ê°œìˆ˜,
                    ì—‘ì…€ë°ì´í„°=df_ì›ë³¸,
                    ëª©í‘œí‰ê· ì°¨ì´=ëª©í‘œì°¨ì´
                )
                
                st.session_state['ê²°ê³¼'] = ê²°ê³¼
                st.session_state['í”„ë¡œê·¸ë¨'] = í”„ë¡œê·¸ë¨
                st.session_state['ì™„ë£Œ'] = True
                
            except Exception as e:
                st.error(f"âŒ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {str(e)}")
                st.stop()

    # ===== 4. ê²°ê³¼ í‘œì‹œ =====
    if st.session_state.get('ì™„ë£Œ'):
        í”„ë¡œê·¸ë¨ = st.session_state['í”„ë¡œê·¸ë¨']
        ê²°ê³¼ = st.session_state['ê²°ê³¼']
        
        st.divider()
        st.markdown("### ğŸ“Š ë°°ì¹˜ ê²°ê³¼")
        
        # ìš”ì•½ ì¹´ë“œ
        ë°˜ë³„í‰ê·  = [ê²°ê³¼[ê²°ê³¼['ë°°ì •ë°˜'] == i]['ì„±ì '].mean() for i in range(1, ë°˜ê°œìˆ˜ + 1)]
        ë°˜ë³„ì¸ì› = [len(ê²°ê³¼[ê²°ê³¼['ë°°ì •ë°˜'] == i]) for i in range(1, ë°˜ê°œìˆ˜ + 1)]
        
        col1, col2, col3 = st.columns(3)
        with col1:
            st.metric("ì´ í•™ìƒ ìˆ˜", f"{len(ê²°ê³¼)}ëª…")
        with col2:
            st.metric("ë°˜ë³„ í‰ê·  ì°¨ì´", f"{max(ë°˜ë³„í‰ê· )-min(ë°˜ë³„í‰ê· ):.2f}ì ")
        with col3:
            st.metric("ë°˜ë³„ ì¸ì› ì°¨ì´", f"{max(ë°˜ë³„ì¸ì›)-min(ë°˜ë³„ì¸ì›)}ëª…")
        
        # ë°˜ë³„ ìƒì„¸
        st.markdown("#### ë°˜ë³„ ìƒì„¸ ì •ë³´")
        
        ë°˜ë³„ì •ë³´ = []
        for ë°˜ in range(1, ë°˜ê°œìˆ˜ + 1):
            ë°˜ë°ì´í„° = ê²°ê³¼[ê²°ê³¼['ë°°ì •ë°˜'] == ë°˜]
            ë‚¨ = len(ë°˜ë°ì´í„°[ë°˜ë°ì´í„°['ì„±ë³„'] == 'ë‚¨'])
            ì—¬ = len(ë°˜ë°ì´í„°[ë°˜ë°ì´í„°['ì„±ë³„'] == 'ì—¬'])
            ë°˜ë³„ì •ë³´.append({
                'ë°˜': f"{ë°˜}ë°˜",
                'ë‚¨ì': f"{ë‚¨}ëª…",
                'ì—¬ì': f"{ì—¬}ëª…",
                'ì´ì¸ì›': f"{len(ë°˜ë°ì´í„°)}ëª…",
                'í‰ê· ': f"{ë°˜ë°ì´í„°['ì„±ì '].mean():.2f}ì ",
                'ìµœê³ ì ': f"{ë°˜ë°ì´í„°['ì„±ì '].max():.2f}ì ",
                'ìµœì €ì ': f"{ë°˜ë°ì´í„°['ì„±ì '].min():.2f}ì ",
            })
        
        st.dataframe(pd.DataFrame(ë°˜ë³„ì •ë³´), use_container_width=True, hide_index=True)
        
        # ì „ì²´ ê²°ê³¼ ë³´ê¸°
        with st.expander("ğŸ“‹ ì „ì²´ ë°°ì¹˜ ê²°ê³¼ ë³´ê¸°"):
            ë³´ê¸°ìš© = ê²°ê³¼[['ë°°ì •ë°˜', 'ì´ë¦„', 'ì„±ë³„', 'ì„±ì ']].sort_values(
                ['ë°°ì •ë°˜', 'ì„±ë³„', 'ì„±ì '], ascending=[True, True, False]
            ).reset_index(drop=True)
            st.dataframe(ë³´ê¸°ìš©, use_container_width=True, height=400)
        
        # ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
        st.divider()
        st.markdown("### ğŸ“¥ ê²°ê³¼ ë‹¤ìš´ë¡œë“œ")
        st.info("ğŸ’¡ ì•„ë˜ ë²„íŠ¼ì„ í´ë¦­í•˜ë©´ ì—‘ì…€ íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë©ë‹ˆë‹¤. ì„œì‹ê³¼ ìƒ‰ìƒì´ ì ìš©ë˜ì–´ ìˆì–´ìš”!")
        
        ì—‘ì…€_ë°ì´í„° = í”„ë¡œê·¸ë¨.ê²°ê³¼_ì—‘ì…€ìƒì„±()
        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        
        st.download_button(
            label="ğŸ“¥ ì—‘ì…€ íŒŒì¼ ë‹¤ìš´ë¡œë“œ",
            data=ì—‘ì…€_ë°ì´í„°,
            file_name=f"ë°˜ë°°ì¹˜_ê²°ê³¼_{timestamp}.xlsx",
            mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
            type="primary",
            use_container_width=True
        )

else:
    # íŒŒì¼ ì—…ë¡œë“œ ì „ ì•ˆë‚´
    st.markdown("---")
    st.markdown("""
    ### ğŸ“Œ ì‚¬ìš© ë°©ë²•
    
    1. **ì—‘ì…€ íŒŒì¼ ì˜¬ë¦¬ê¸°** - ìœ„ì—ì„œ í•™ìƒ ëª…ë¶€ íŒŒì¼ì„ ì˜¬ë¦½ë‹ˆë‹¤
    2. **ì„¤ì • ì…ë ¥** - ë°˜ ê°œìˆ˜ì™€ ëª©í‘œ í‰ê·  ì°¨ì´ë¥¼ ì…ë ¥í•©ë‹ˆë‹¤
    3. **ë°˜ë°°ì¹˜ ì‹œì‘** - ë²„íŠ¼ í•˜ë‚˜ë§Œ ëˆ„ë¥´ë©´ ìë™ìœ¼ë¡œ ì™„ë£Œ!
    4. **ê²°ê³¼ ë‹¤ìš´ë¡œë“œ** - ì„œì‹ì´ ì ìš©ëœ ì—‘ì…€ íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤
    
    ### ğŸ“‹ ì—‘ì…€ íŒŒì¼ ì–‘ì‹
    
    íŒŒì¼ì— ë‹¤ìŒ ì»¬ëŸ¼ì´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤:
    
    | ì´ë¦„(ë˜ëŠ” ì„±ëª…) | ì„±ë³„ | ì„±ì (ë˜ëŠ” í‰ê· /ì´ì ) | ë¹„ê³  (ì„ íƒ) |
    |:---:|:---:|:---:|:---:|
    | í™ê¸¸ë™ | ë‚¨ | 85.5 | ë™ëª…ì´ì¸ |
    | ê¹€ì˜í¬ | ì—¬ | 92.3 | |
    | í™ê¸¸ë™ | ë‚¨ | 78.1 | ë™ëª…ì´ì¸ |
    
    **ë¹„ê³  ì»¬ëŸ¼**ì— 'ë™ëª…ì´ì¸', 'ìŒë‘¥ì´', 'ìš´ë™ë¶€'ë¥¼ í‘œì‹œí•˜ë©´ í•´ë‹¹ í•™ìƒë“¤ì€ ìë™ìœ¼ë¡œ ë‹¤ë¥¸ ë°˜ì— ë°°ì¹˜ë©ë‹ˆë‹¤.
    """)

# í•˜ë‹¨ ì •ë³´
st.markdown("---")
st.markdown(
    '<p style="text-align:center; color:#999; font-size:0.9rem;">'
    'ğŸ’ ì‚¬ë‘í•˜ëŠ” ì–´ë¨¸ë‹ˆë¥¼ ìœ„í•´ ë§Œë“  í”„ë¡œê·¸ë¨ì…ë‹ˆë‹¤ ğŸ’'
    '</p>', 
    unsafe_allow_html=True
)
